<div id="app" class="mb-2">
    <el-row class="mb-2" :gutter="10">
        <el-col :lg="4" :md="8">
            <el-date-picker
                v-model="kpi_summary.datetime"
                @change="load_kpi_summary"
                type="month"
                size="small"
                value-format="yyyy-MM-dd"
                placeholder="选择月份"
                style="width: 100%;"
            />
        </el-col>
        <el-col :lg="4" :md="8">
            <el-select
                v-model="kpi_summary.user_id"
                @change="load_kpi_summary"
                size="small"
                clearable
                :disabled="mode === 'edit'"
                placeholder="选择员工"
                style="width: 100%;"
            >
                <el-option
                    v-for="item in users"
                    :key="item[1]"
                    :label="item[0]"
                    :value="item[1]">
                </el-option>
            </el-select>
        </el-col>
    </el-row>
    <el-row class="mb-2">
        <el-col :lg="8" :md="16">
            <el-tree
                v-if="init_data.name"
                :data="[init_data]"
                node-key="id"
                :props="{ label: 'name', children: 'infos' }"
                default-expand-all
                :expand-on-click-node="false" style="width: 100%;">
                <span class="c-tree-node" slot-scope="{ node, data }">
                        <span :class="data.user_id ? 'text-bold' : ''">{{ node.label }}</span>
                        <span>
                            <el-input v-if="!data.user_id" size="mini" type="number"
                                placeholder="输入金额"
                                v-model="data.price"
                                :disabled="data.disabled"
                                clearable>
                            </el-input>
                        </span>
                </span>
            </el-tree>
        </el-col>
    </el-row>
    <el-button type="primary" size="small" @click="submit">提交</el-button>
    <el-link href="/kpi_summaries" :underline="false">
        <el-button type="info" size="small">返回</el-button>
    </el-link>
</div>

<script>
    var app = new Vue({
        el: '#app',
        data: {
            mode: '',  // new/edit
            users: [],
            kpi_summary: {
                id: '<%= kpi_summary_id %>',
                datetime: '',
                user_id: ''
            },
            init_data: {}
        },
        mounted: function(){
            this.$nextTick(function(){
                let _this_ = this;
                $.get(`/users/v_staff_options`, function(res) {
                    if (res.status === 0) {
                        _this_.users = res.data.users
                    } else if (res.status === 1) {
                        _this_.$message({ message: res.msg, type: 'error' })
                    }
                })
                if (this.kpi_summary.id) {
                    this.mode = 'edit'
                    console.log('edit mode')
                    // $.get(`/costs/v_summary_show?cost_summary_id=${this.cost_summary.id}`, function(res) {
                    //     if (res.status === 0) {
                    //         _this_.set_cost_summary(res.data.cost_summary)
                    //         console.log(`load cost summary(${_this_.cost_summary.id}):ok`, res)
                    //     } else if (res.status === 1) {
                    //         _this_.$message({ message: res.msg, type: 'error' })
                    //     }
                    // })
                } else {
                    this.mode = 'new'
                }
            })
        },
        computed: {
        },
        methods: {
            load_kpi_summary () {
                if (this.kpi_summary.datetime && this.kpi_summary.user_id) {
                    let _this_ = this
                    $.get(`/kpi_summaries/v_summary_init?datetime=${this.kpi_summary.datetime}&user_id=${this.kpi_summary.user_id}`, function (res) {
                        if (res.status === 0) {
                            _this_.init_data = res.data
                            console.log('init_data:', _this_.init_data)
                        } else if (res.status === 1) {
                            _this_.$message({ message: res.msg, type: 'error' })
                        }
                    })
                } else {
                    this.init_data = []
                }
            },
            submit() {
                let _this_ = this
                if (!this.kpi_summary.datetime) { 
                    this.$message({ message: '请选择月份', type: 'warning' });
                    return
                }
                if (!this.kpi_summary.user_id) {
                    this.$message({ message: '请选择员工', type: 'warning' });
                    return
                }
                // let params = { costs: [] }
                // params.datetime = this.cost_summary.datetime
                // params.costs = Object.keys(this.cost_summary.costs).map(k => {
                //     return { cost_type_id: k * 1, price: this.cost_summary.costs[k] * 1 }
                // })
                // if(this.cost_summary.id) {
                //     params.cost_summary_id = this.cost_summary.id
                //     $.post('/costs/v_summary_update', params, function(res) {
                //         console.log('v_summary_update res:', res)
                //         if (res.status === 0) {
                //             _this_.set_cost_summary(res.data.cost_summary)
                //             _this_.$message({ message: '提交成功', type: 'success' })
                //         } else if (res.status === 1) {
                //             _this_.$message({ message: res.msg, type: 'error' })
                //         }
                //     })
                // } else {
                //     console.log('params:', JSON.stringify(params))
                //     $.post('/costs/v_summary_create', params, function(res) {
                //         console.log('v_summary_create res:', res)
                //         if (res.status === 0) {
                //             _this_.set_cost_summary(res.data.cost_summary)
                //             _this_.$message({ message: '提交成功', type: 'success' })
                //         } else if (res.status === 1) {
                //             _this_.$message({ message: res.msg, type: 'error' })
                //         }
                //     })
                // }
            }
        }
    })
</script>

<style>
  .c-tree-node {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    padding-right: 8px;
  }
  .el-tree-node__content {
    height: 30px;
  }
</style>